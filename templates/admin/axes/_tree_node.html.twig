{# Tree node component - recursive #}
{% set hasChildren = node.children is not empty %}
{% set isSection = node.level == 'section' %}
{% set isHighlighted = node.highlighted|default(false) %}
{% set entity = node.entity %}
{% set nextLevel = {section: 'axe1', axe1: 'axe2', axe2: 'axe3'}[node.level]|default(null) %}
{% set canAddChild = nextLevel is not null and tree.inheritance[nextLevel ~ 'Inherits' ~ (node.level == 'section' ? 'Section' : node.level|capitalize)]|default(true) %}

<div class="tree-node"
     x-data="{ expanded: true }"
     data-level="{{ node.level }}"
     data-id="{{ entity.id }}">

    <div class="flex items-center gap-1 py-1.5 px-2 rounded-md hover:bg-gray-50 group transition-colors {{ isHighlighted ? 'bg-yellow-50' : '' }}"
         style="padding-left: {{ depth * 1.5 + 0.5 }}rem;">

        {# Expand/Collapse toggle #}
        {% if hasChildren %}
            <button type="button"
                    x-on:click.stop="expanded = !expanded"
                    class="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors">
                <svg x-show="expanded" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
                <svg x-show="!expanded" x-cloak class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        {% else %}
            <span class="w-5 h-5 flex items-center justify-center text-gray-300">
                <svg class="w-2 h-2" fill="currentColor" viewBox="0 0 8 8">
                    <circle cx="4" cy="4" r="3"/>
                </svg>
            </span>
        {% endif %}

        {# Color badge for sections #}
        {% if isSection and entity.couleur %}
            <span class="w-3 h-3 rounded-full flex-shrink-0 border"
                  style="{{ entity.couleurStyle }}"></span>
        {% endif %}

        {# Code + Libelle #}
        <div class="flex-1 flex items-center gap-2 min-w-0">
            <span class="font-mono text-sm font-medium text-gray-900 {{ not entity.actif ? 'opacity-50' : '' }}">
                {{ entity.code }}
            </span>
            <span class="text-sm text-gray-600 truncate {{ not entity.actif ? 'opacity-50' : '' }}">
                {{ entity.libelle }}
            </span>
            {% if not entity.actif %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500">
                    Inactif
                </span>
            {% endif %}
        </div>

        {# Actions (visible on hover) #}
        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            {# Add child button #}
            {% if canAddChild and nextLevel %}
                <button type="button"
                        hx-get="{{ path('app_admin_axes_panel_new', {level: nextLevel, parentId: entity.id}) }}"
                        hx-target="#side-panel"
                        hx-swap="innerHTML"
                        class="p-1 text-gray-400 hover:text-primary-600 hover:bg-primary-50 rounded transition-colors"
                        title="Ajouter un {{ axe_label(nextLevel)|lower }}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </button>
            {% endif %}

            {# Edit button #}
            <button type="button"
                    hx-get="{{ path('app_admin_axes_panel_edit', {level: node.level, id: entity.id}) }}"
                    hx-target="#side-panel"
                    hx-swap="innerHTML"
                    class="p-1 text-gray-400 hover:text-primary-600 hover:bg-primary-50 rounded transition-colors"
                    title="Modifier">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
            </button>
        </div>
    </div>

    {# Children (recursive) #}
    {% if hasChildren %}
        <div x-show="expanded" x-collapse>
            {% for childNode in node.children %}
                {% include 'admin/axes/_tree_node.html.twig' with {
                    node: childNode,
                    depth: depth + 1,
                    tree: tree
                } %}
            {% endfor %}
        </div>
    {% endif %}
</div>
